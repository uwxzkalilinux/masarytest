<script>
  const { createClient } = supabase;
  const client = createClient(
    'https://xioxpdhdsphtclicicyn.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhpb3hwZGhkc3BodGNsaWNpY3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1NTcwNTAsImV4cCI6MjA2OTEzMzA1MH0.Pjb0J22RJTS0mC1EYmiH4k45JHlHO-9Pksf_y-c_H-g'
  );

  function getDeviceFingerprint() {
    return navigator.userAgent + " | " + navigator.platform;
  }

  async function checkDevice(userId) {
    const device = getDeviceFingerprint();

    const { data, error } = await client
      .from('user_devices')
      .select('*')
      .eq('user_id', userId)
      .eq('device_info', device);

    if (error) {
      console.error("❌ خطأ في جلب الأجهزة:", error);
      return;
    }

    if (data.length === 0) {
      alert("⚠️ تسجيل الدخول من جهاز جديد");

      const { error: insertError } = await client
        .from('user_devices')
        .insert([{ user_id: userId, device_info: device }]);

      if (insertError) {
        console.error("❌ فشل حفظ الجهاز:", insertError);
      } else {
        console.log("✅ جهاز جديد تم حفظه");
      }
    } else {
      console.log("✅ الجهاز معروف ومخزن مسبقاً");
    }
  }

  document.getElementById('loginForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    const { data, error } = await client.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      console.error("❌ تفاصيل الخطأ:", error);
      alert("⚠️ خطأ في تسجيل الدخول: " + error.message);
      return;
    }

    const user = data.user;
    console.log("✅ تم تسجيل الدخول:", user.email);

    await checkDevice(user.id);

    localStorage.setItem("isLoggedIn", "true");
    window.location.href = "index.html";
  });
</script>
